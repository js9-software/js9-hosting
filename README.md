# JS9 Hosting

This repository contains configuration as code for the js9.org servers. There are two main things here:

- Terraform configurations for two Oracle Cloud instances (these were generated by exporting pre-configured Stacks)
- An Ansible playbook for configuring those instances.

## Oracle Cloud instance configuration

There are two servers configured under the pay-as-you-go `matilsky` cloud account:

### `js9-hosting`

An ARM-based server that should be within free resource allotment.

```
Shape:       VM.Standard.A1.Flex
OCPU count:  4
Memory:      24GB
IP:          150.136.163.175
Hostname:    prod-a.js9.org
```

According to the [Always Free docs](https://docs.oracle.com/en-us/iaas/Content/FreeTier/freetier_topic-Always_Free_Resources.htm):
  > OCI Ampere A1 Compute instances (Arm processor): All tenancies get the first 3,000 OCPU hours and 18,000 GB hours per month for free for VM instances using the VM.Standard.A1.Flex shape, which has an Arm processor. For Always Free tenancies, this is equivalent to _4 OCPUs and 24 GB of memory_.

### `js9-x86-hosting`

An 'Always free' instance used to host NSO's JS9, which has issues running the power spectrum analyis on ARM.

```
Shape:       VM.Standard.E2.1.Micro
OCPU count:  1
Memory:      1GB
IP:          143.47.98.233
Hostname:    prod-x.js9.org
```

These instances were created in the web UI and saved as 'Stacks'. The Stack configurations were downloaded to this repo as Terraform (`.tf` files).

Both servers are running the `Canonical Ubuntu 24.04 Minimal` image.

### Firewall / Opening ports

I'm not sure that networking can be configured in Terraform, so here are the steps to open ports 80 and 443 on the servers:

Instance > Virtual cloud network (click on network link) > Security (tab link) > Security Lists (click on only item in that list) > Security rules (tab link) > Add ingress rules

For web traffic:

- Source CIDR: `0.0.0.0/0`
- IP Protocol: `TCP`
- Destination port range: `80`

For encrypted web traffic:

- Source CIDR: `0.0.0.0/0`
- IP Protocol: `TCP`
- Destination port range: `443`

Both servers share the same virtual cloud network, so these settings are shared.

## Server configuration with Ansible

The following server configuration is done via Ansible:

- Setting the hostname
- Setting the time zone
- SSH hardening
- Installation of required packages (docker, unattended-upgrades, etc.)
- Reverse proxy container installation and configuration
- JS9 web application container installation

To run the Ansible playbook:

```
ansible-playbook main.yml
```

To test the playbook (Dry run):

```
$ ansible-playbook --check --diff main.yml
```

## Web application lifecycle

As of 2025-06, all containerized applications (Caddy reverse proxy, www.js9.org, and nso.js9.org) are started, stopped, restarted, and updated manually.

### Caddy reverse proxy

[Caddy docker proxy](https://github.com/lucaslorentz/caddy-docker-proxy) is used in front of all web applications for TLS termination. Configuration is automatic via Docker labels.

All commands below should be run after remotely connecting to a server (e.g. `ssh ubuntu@prod-x.js9.org`).

#### Starting the reverse proxy

```
cd /apps/caddy
docker compose up -d
```

Once running, the reverse proxy container will restart when the server is rebooted.

#### Stopping the reverse proxy

```
cd /apps/caddy
docker compose down
```

#### Watching the reverse proxy logs

```
cd /apps/caddy
docker compose logs -f
```

#### Upgrading the reverse proxy

```
cd /apps/caddy
docker compose pull
docker compose up -d
```

### nso.js9.org

This is a custom instance of JS9 that extends the default JS9 application container with additional analysis tools and custom content.

The ansible playbook will clone the [js9-nso repo](https://github.com/js9-software/js9-nso) to the `prod-x.js9.org` host.

A task in the playbook configures the clone to automatically update the working copy when used as a remote and receiving git pushes.

So to update the nso.js9.org application after the playbook has created it:

```
cd local/clone/of/js9-nso
git remote add web-prod-x ubuntu@prod-x.js9.org:/apps/js9-nso  # Only needs to be done once
git push main web-prod-x # To update the working copy on prod-x any time new commits are made to repo
```

Once the application is updated, it can be started, restarted, and stopped just like the Caddy reverse proxy. For example:

#### Restarting the nso.js9.org web application

```
cd /apps/js9-nso
docker compose up -d
docker compose up --build -d  # Run this instead of the above if there are changes to the Docker file
```
